<?php
/**
 * Single Donation Template
 * Template for displaying donation pages
 */

get_header('custom');

// Get all donation data from plugin (with fallbacks if plugin is inactive)
if (function_exists('ctf_get_donation_data')) {
    $donation_data = ctf_get_donation_data();
    $donation_amounts = $donation_data['amounts'];
    $auto_tag = $donation_data['auto_tag'];
    $show_title = $donation_data['show_title'];
    $campaign_id = $donation_data['campaign_id'];
} else {
    // Fallback if plugin is not active - will be overridden by JS
    $donation_amounts = [15, 20, 25];
    $auto_tag = false;
    $show_title = true;
    $campaign_id = 'donation_' . get_the_ID();
}

// Set default amounts for monthly and one-time donations
// Always use these specific amounts regardless of ACF field
$monthly_amounts = [15, 20, 25];
$onetime_amounts = [15, 20, 25, 50, 100, 200];
?>

<div class="donation-template card">
    <div class="donation-header">
        <?php if ($show_title && have_posts()) : ?>
            <?php while (have_posts()) : the_post(); ?>
                <h1><?php the_title(); ?></h1>
            <?php endwhile; ?>
        <?php else: ?>
            <h1>You clicked to donate â€“ here's your next step:</h1>
        <?php endif; ?>
        
        <div class="donation-intro">
            <?php if (have_posts()) : ?>
                <?php while (have_posts()) : the_post(); ?>
                    <?php if (get_the_content()) : ?>
                        <div class="donation-content">
                            <?php the_content(); ?>
                        </div>
                    <?php else: ?>
                        <!-- Default content if no custom content is provided -->
                        <p>For 99% of people, it's a big step to read the stories and sign the petitions on Taxpayer.com. We're grateful to all of those people.</p>
                        
                        <p><strong>But what about the other 1%?</strong></p>
                        
                        <p>About 1% of people who support the Canadian Taxpayers Federation make a donation.</p>
                        
                        <p>Those core donors are the reason we can take a stand for lower taxes, less waste and more accountable government.</p>
                        
                        <p><strong>You can donate now on the secure form below!</strong></p>
                    <?php endif; ?>
                <?php endwhile; ?>
            <?php endif; ?>
        </div>
    </div>

    <div class="donation-options">
        <div class="donation-frequency-toggle">
            <input type="radio" id="frequency-monthly" name="frequency_toggle" value="monthly">
            <input type="radio" id="frequency-once" name="frequency_toggle" value="once" checked>
            <div class="toggle-slider"></div>
            <label for="frequency-monthly" class="toggle-label">DONATE MONTHLY</label>
            <label for="frequency-once" class="toggle-label">DONATE TODAY</label>
        </div>
        
        <div class="frequency-description">
            <p id="monthly-description" class="description">A monthly gift will go even further to hold politicians accountable and fight for lower taxes and against government waste.</p>
            <p id="once-description" class="description active">Make a one-time donation to support our campaigns for lower taxes and accountable government.</p>
        </div>
    </div>

    <form class="donation-form" method="post" action="<?php echo esc_url(admin_url('admin-post.php')); ?>">
        <input type="hidden" name="action" value="process_donation" />
        <input type="hidden" name="donation_frequency" id="donation_frequency" value="once" />
        <input type="hidden" name="campaign_id" value="<?php echo esc_attr($campaign_id); ?>" />
        <input type="hidden" name="auto_tag" value="<?php echo $auto_tag ? '1' : '0'; ?>" />
        <input type="hidden" name="post_id" value="<?php echo get_the_ID(); ?>" />
        <input type="hidden" name="amount" id="final_amount" value="" />
        <?php wp_nonce_field('donation_form', 'donation_nonce'); ?>
        
        <div class="amount-section">
            <h3>Donation amount:</h3>
            <div class="amount-grid" id="amount-grid">
                <!-- Amounts will be dynamically generated by JavaScript -->
            </div>
            
            <div class="donation-note">
                <p><strong>Donations of $100 and higher receive The Taxpayer magazine.</strong></p>
                <p><em>Donations to the Canadian Taxpayers Federation are not tax deductible</em></p>
            </div>
        </div>

        <div class="donor-info-section">
            <h3>Enter your information:</h3>
            <div class="form-grid">
                <div class="form-group">
                    <input type="text" name="first_name" class="form-control" required placeholder="First Name *" autocomplete="given-name" />
                </div>
                <div class="form-group">
                    <input type="text" name="last_name" class="form-control" required placeholder="Last Name *" autocomplete="family-name" />
                </div>
                <div class="form-group">
                    <input type="email" name="email" class="form-control" required placeholder="Email *" autocomplete="email" />
                </div>
                <div class="form-group">
                    <input type="tel" name="phone" class="form-control" placeholder="Phone" autocomplete="tel" />
                </div>
                <div class="form-group">
                    <input type="text" name="address" class="form-control" placeholder="Street Address" autocomplete="street-address" />
                </div>
                <div class="form-group">
                    <input type="text" name="city" class="form-control" placeholder="City" autocomplete="address-level2" />
                </div>
                <div class="form-group">
                    <select name="province" class="form-control" autocomplete="address-level1">
                        <option value="">Select Province</option>
                        <option value="AB">Alberta</option>
                        <option value="BC">British Columbia</option>
                        <option value="MB">Manitoba</option>
                        <option value="NB">New Brunswick</option>
                        <option value="NL">Newfoundland and Labrador</option>
                        <option value="NS">Nova Scotia</option>
                        <option value="ON">Ontario</option>
                        <option value="PE">Prince Edward Island</option>
                        <option value="QC">Quebec</option>
                        <option value="SK">Saskatchewan</option>
                        <option value="NT">Northwest Territories</option>
                        <option value="NU">Nunavut</option>
                        <option value="YT">Yukon</option>
                    </select>
                </div>
                <div class="form-group">
                    <input type="text" name="postal_code" class="form-control" placeholder="Postal Code" autocomplete="postal-code" pattern="[A-Za-z]\d[A-Za-z] ?\d[A-Za-z]\d" />
                </div>
            </div>
        </div>

        <div class="payment-section">
            <h3>Credit card information</h3>
            <div class="form-grid">
                <div class="form-group full-width">
                    <input type="text" name="cardholder_name" class="form-control" required placeholder="Cardholder name *" autocomplete="cc-name" />
                </div>
                <div class="form-group">
                    <input type="text" name="card_number" class="form-control" required placeholder="Card number *" autocomplete="cc-number" maxlength="19" />
                </div>
                <div class="form-group">
                    <input type="text" name="cvv" class="form-control" required placeholder="CVV *" autocomplete="cc-csc" maxlength="4" />
                </div>
                <div class="form-group">
                    <select name="expiry_month" class="form-control" required autocomplete="cc-exp-month">
                        <option value="">Month</option>
                        <?php for($i = 1; $i <= 12; $i++): ?>
                            <option value="<?php echo sprintf('%02d', $i); ?>"><?php echo sprintf('%02d', $i); ?></option>
                        <?php endfor; ?>
                    </select>
                </div>
                <div class="form-group">
                    <select name="expiry_year" class="form-control" required autocomplete="cc-exp-year">
                        <option value="">Year</option>
                        <?php for($i = date('Y'); $i <= date('Y') + 10; $i++): ?>
                            <option value="<?php echo $i; ?>"><?php echo $i; ?></option>
                        <?php endfor; ?>
                    </select>
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary btn-large donate-button">Donate</button>
        </div>
    </form>

    <div class="other-options">
        <h3>Other donation options</h3>
        
        <div class="option-list">
            <p><strong>Debit Cards:</strong> If you have a Visa or Mastercard debit card you can use it to make a donation using the Credit Card Information form above.</p>
            
            <p><strong>PayPal:</strong> <a href="https://www.taxpayer.com/utilities/paypal?Id=1&IdCampaigns=18519" target="_blank" rel="noopener">Click here to donate via PayPal</a></p>
            
            <p><strong>By calling:</strong> 1-800-667-7933</p>
            
            <p><strong>E-transfer:</strong> Send to admin@taxpayer.com</p>
            
            <p><strong>By mail:</strong> <a href="https://www.taxpayer.com/media/Donation%20Form_updatedJuly2025.pdf" target="_blank" rel="noopener">Click here</a> for a printable version of our donation form.<br>
            Mail: 501 - 2201 11th Ave, Regina, SK S4P 0J8</p>
            
            <p><strong>Legacy giving:</strong> <a href="https://www.taxpayer.com/donate/a-guide-to-legacy-giving" target="_blank" rel="noopener">Click here</a> if you would like more information on leaving a permanent contribution to the Canadian Taxpayers Federation!</p>
        </div>
        
        <div class="contact-info">
            <p>If you have any questions regarding your donation please contact us at <a href="mailto:admin@taxpayer.com">admin@taxpayer.com</a></p>
        </div>
    </div>
</div>

<?php get_footer('custom'); ?>

<script>
// Pass donation amounts to JavaScript
window.donationAmounts = {
    monthly: <?php echo json_encode($monthly_amounts); ?>,
    onetime: <?php echo json_encode($onetime_amounts); ?>
};
</script>
